"use strict";function throttle(e,o,t){var n,i,a,l=null,d=0;t||(t={});var s=function(){d=t.leading===!1?0:(new Date).getTime(),l=null,a=e.apply(n,i),l||(n=i=null)};return function(){var c=(new Date).getTime();d||t.leading!==!1||(d=c);var r=o-(c-d);return n=this,i=arguments,r<=0||r>o?(clearTimeout(l),l=null,d=c,a=e.apply(n,i),l||(n=i=null)):l||t.trailing===!1||(l=setTimeout(s,r)),a}}function createTemplate(){var e=this.isLabelMode,o=this.config.searchable,t=o?'<span class="dropdown-search">'+this.config.input+"</span>":"";return e?'<div class="dropdown-display-label"><div class="dropdown-chose-list">'+t+'</div></div><div class="dropdown-main">{{ul}}</div>':'<a href="javascript:;" class="dropdown-display"><span class="dropdown-chose-list"></span></a><div class="dropdown-main">'+t+"{{ul}}</div>"}function maxItemAlert(){var e=this,o=e.config,t=e.$el,n=t.find(".dropdown-maxItem-alert");clearTimeout(e.maxItemAlertTimer),0===n.length&&(n=$('<div class="dropdown-maxItem-alert">最多可选择'+o.limitCount+"个</div>")),t.append(n),e.maxItemAlertTimer=setTimeout(function(){t.find(".dropdown-maxItem-alert").remove()},1e3)}function selectToDiv(e){var o=e||"";return o=o.replace(/<select[^>]*>/gi,"<ul>").replace("</select","</ul"),o=o.replace(/<\/optgroup>/gi,""),o=o.replace(/<optgroup[^>]*>/gi,function(e){var o=/label="(.[^"]*)"(\s|>)/.exec(e),t=/data\-group\-id="(.[^"]*)"(\s|>)/.exec(e);return'<li class="dropdown-group" data-group-id="'+(t[1]||"")+'">'+(o[1]||"")+"</li>"}),o=o.replace(/<option(.*?)<\/option>/gi,function(e){var o=/value="(.[^"]*)"(\s|>)/.exec(e),t=/>(.*)<\//.exec(e),n=e.indexOf("selected")>-1,i=e.indexOf("disabled")>-1;return"<li "+(i?" disabled":' tabindex="0"')+'  \n                                    data-value="'+(o[1]||"")+'" \n                                    class="dropdown-option '+(n?"dropdown-chose":"")+'">'+(t[1]||"")+"</li>"})}function objectToSelect(e){var o={},t="",n=[],i=0;return!(!e||!e.length)&&($.each(e,function(e,t){var a=t.groupId,l=t.disabled?" disabled":"",d=t.selected&&!l?" selected":"",s="<option"+l+d+' value="'+t.id+'">'+t.name+"</option>";d&&(n.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'),i++),a?o[t.groupId]?o[t.groupId]+=s:o[t.groupId]=t.groupName+"&janking&"+s:o[e]=s}),$.each(o,function(e,o){var n=o.split("&janking&");if(2===n.length){var i=n[0],a=n[1];t+='<optgroup label="'+i+'" data-group-id="'+e+'">'+a+"</optgroup>"}else t+=o}),[t,n,i])}function selectToObject(e){function o(e,o){var t=$(o);this.id=t.prop("value"),this.name=t.text(),this.disabled=t.prop("disabled"),this.selected=t.prop("selected")}var t=e,n=[];return $.each(t.children(),function(e,t){var i={},a={},l=$(t);"OPTGROUP"===t.nodeName?(a.groupId=l.data("groupId"),a.groupName=l.attr("label"),$.each(l.children(),$.proxy(o,i)),$.extend(i,a)):$.each(l,$.proxy(o,i)),n.push(i)}),n}function Dropdown(e,o){this.$el=$(o),this.$select=this.$el.find("select"),this.placeholder=this.$select.attr("placeholder"),this.config=e,this.name=[],this.isSingleSelect=!this.$select.prop("multiple"),this.selectAmount=0,this.maxItemAlertTimer=null,this.isLabelMode="label"===this.config.multipleMode,this.init()}var isSafari=function(){var e=navigator.userAgent.toLowerCase();if(e.indexOf("safari")!==-1)return!(e.indexOf("chrome")>-1)}(),settings={readOnly:!1,limitCount:1/0,input:'<input type="text" maxLength="20" placeholder="搜索关键词或ID">',data:[],searchable:!0,searchNoData:'<li style="color:#ddd">查无数据，换个词儿试试 /(ㄒoㄒ)/~~</li>',choice:function(){}},KEY_CODE={up:38,down:40,enter:13},action={show:function(e){e.stopPropagation();var o=this;$(document).trigger("click.dropdown"),o.$el.toggleClass("active")},search:throttle(function(e){var o=this,t=o.config,n=o.$el,i=$(e.target),a=i.val(),l=o.config.data,d=[];e.keyCode>36&&e.keyCode<41||($.each(l,function(e,o){(o.name.toLowerCase().indexOf(a)>-1||""+o.id==""+a)&&d.push(o)}),n.find("ul").html(selectToDiv(objectToSelect(d)[0])||t.searchNoData))},300),control:function(e){var o,t,n,i=e.keyCode,a=KEY_CODE,l=0;i!==a.down&&i!==a.up||(o=i===a.up?-1:1,n=this.$el.find("[tabindex]"),t=n.index($(document.activeElement)),l=t===-1?o+1?-1:0:t,l+=o,l===n.length&&(l=0),n.eq(l).focus(),e.preventDefault())},multiChoose:function(e){var o=this,t=o.config,n=o.$select,i=$(e.target),a=i.data("value"),l=i.hasClass("dropdown-chose");if(l)i.removeClass("dropdown-chose"),o.selectAmount--;else{if(!(o.selectAmount<t.limitCount))return maxItemAlert.call(o),!1;i.addClass("dropdown-chose"),o.selectAmount++}o.name=[],$.each(t.data,function(e,t){""+t.id==""+a&&(t.selected=!l),t.selected&&o.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>')}),n.find('option[value="'+a+'"]').prop("selected",!l),o.$choseList.find(".dropdown-selected").remove(),o.$choseList.prepend(o.name.join("")),t.choice.call(o,e)},singleChoose:function(e){var o=this,t=o.config,n=o.$el,i=o.$select,a=$(e.target),l=a.data("value"),d=a.hasClass("dropdown-chose");return o.name=[],!a.hasClass("dropdown-chose")&&(n.removeClass("active").find("li").not(a).removeClass("dropdown-chose"),a.toggleClass("dropdown-chose"),$.each(t.data,function(e,t){t.selected=!1,""+t.id==""+l&&(t.selected=d?0:1,t.selected&&o.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'))}),i.find('option[value="'+l+'"]').prop("selected",!0),o.name.push('<span class="placeholder">'+o.placeholder+"</span>"),void o.$choseList.html(o.name.join("")))},del:function(e){var o=this,t=$(e.target),n=t.data("id");return $.each(o.name,function(e,t){if(t.indexOf('data-id="'+n+'"')!==-1)return o.name.splice(e,1),!1}),$.each(o.config.data,function(e,o){if(o.id===n)return o.selected=!1,!1}),o.selectAmount--,o.$el.find('[data-value="'+n+'"]').removeClass("dropdown-chose"),o.$el.find('[value="'+n+'"]').prop("selected",!1).removeAttr("selected"),t.closest(".dropdown-selected").remove(),!1}};Dropdown.prototype={init:function(){var e=this,o=e.config,t=e.$el,n=isSafari?"click.iui-dropdown":"focus.iui-dropdown";t.addClass(e.isSingleSelect?"dropdown-single":e.isLabelMode?"dropdown-multiple-label":"dropdown-multiple"),0===o.data.length&&(o.data=selectToObject(e.$select));var i=objectToSelect(o.data);e.name=i[1],e.selectAmount=i[2],e.$select.html(i[0]),e.renderSelect(),t.on("click.iui-dropdown",function(e){e.stopPropagation()}),e.isLabelMode?(t.on("click.iui-dropdown",".dropdown-display-label",function(){t.find("input").focus()}),t.on("click.iui-dropdown",".del",$.proxy(action.del,e)),t.on("focus.iui-dropdown","input",$.proxy(action.show,e)),t.on("keydown.iui-dropdown","input",function(o){8===o.keyCode&&""===this.value&&e.name.length&&t.find(".del").eq(-1).trigger("click")})):t.on(n,".dropdown-display",$.proxy(action.show,e)),t.on("keyup.iui-dropdown","input",$.proxy(action.search,e)),t.on("keyup.iui-dropdown",function(o){var t=o.keyCode,n=KEY_CODE;t===n.enter&&$.proxy(e.isSingleSelect?action.singleChoose:action.multiChoose,e,o)()}),t.on("keydown.iui-dropdown",$.proxy(action.control,e)),t.on("click.iui-dropdown","[tabindex]",$.proxy(e.isSingleSelect?action.singleChoose:action.multiChoose,e))},renderSelect:function(){var e=this,o=e.$el,t=e.$select,n=createTemplate.call(e).replace("{{ul}}",selectToDiv(t.prop("outerHTML")));o.append(n).find("ul").removeAttr("style class"),e.$choseList=o.find(".dropdown-chose-list"),e.isLabelMode||e.$choseList.html($('<span class="placeholder"></span>').text(e.placeholder)),e.$choseList.prepend(e.name.join(""))}},$(document).on("click.dropdown",function(){$(".dropdown-single,.dropdown-multiple,.dropdown-multiple-label").removeClass("active")}),$.fn.dropdown=function(e){return this.each(function(o,t){$(t).data("iui-dropdown",new Dropdown($.extend(!0,{},settings,e),t))}),this};